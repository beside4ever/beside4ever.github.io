---
layout: post
title: "使用React-Native开发iOS原生应用"
date: 2016-08-23 15:20:34 +0800
comments: true
categories: javascript
---
## 项目介绍
我所在的Mini项目第6组要做的项目名称为**我要**。这是一个同时在安卓、iOS、Web三端发布的匿名问答类应用，我们用了大约一个月时间完成设计、开发与测试。

在本项目中，我主要负责的工作是和另一名前端同事一起完成iOS端的开发。为了最大化利用我们本身的技术优势，并在项目过程中学习新的架构和理念，我们选用了React Native框架来进行程序的编写。

<!--more-->

## 框架选择
目前主流的移动端开发模式主要有以下几种：
1. 纯Web页面，浏览器运行，可快速传播，减少用户负担，体验和流畅度较差
2. 纯原生开发，体验较好，学习时间和开发效率相对较长和较慢
3. Hybird App，混合开发，以WebView为Web嵌入的核心，使用jsBirdge让js和native进行交互。

在当前项目的需求下，为了短期内完成一个高体验的应用，使用React Native进行开发几乎是我最好的选择。而且，由于我们的项目需要进行音视频的播放和录制，这种功能也需要原生代码的支持。

这种开发理论上也属于Hybird的一种，只不过原生代码的工作量近似为0（实际项目中我仍旧写了几行原生），所有的逻辑都是我用js编写的，然后由RN编译为原生应用运行。同样的，RN本身也提供一个jsBirdge实现交互。

## 项目架构
在开发之前，我针对项目的需求，对整个项目的架构进行了基本的设计。整个项目架构如下：
- 页面逻辑：首页以一个TabView为顶层，每个Tab内以Navigator为顶层，每个Route为一个页面。
- 接口管理：后台为Restful API服务器，因此我专门写了一个接口逻辑的页面，利用`fetch`函数完成各种http请求，并根据接口类型将`get`,`post`,`delete`方法进行了封装，并对接口地址、返回提示、错误处理进行了统一管理。
- 样式管理：RN的样式是一个类css的js对象，由于RN的组件化特性，我选择抽出一部分共用样式和共用样式定义，统一到一个样式文件进行管理。
- 文案管理：页面中涉及到的所有文案（按钮、提示、固定标题等），我均在同一文件中进行管理，方便开发和维护，并为项目国际化提供了基础。
- 通用模块：项目中的文件下载、文件上传、音视频播放、音视频录制，都编写为了独立的组件，在程序中可随时调用。

## 所用技术
项目中涉及到的技术大致如下：
- 基本框架：React Native
- 包管理：npm、cocoapods（只在其中一个原生插件中有使用）
- 语言：支持ES6的javascript，广泛使用了ES6新特性（箭头函数、类机制、模块化等）
- 调试：watchman、chrome debug、iOS simulator

## 组件化
React的核心思想是讲页面中的内容组件化，一切业务由一个组件的树状结构组成。在项目中我利用这个思想写出了可高度复用的代码，举个例子，我们的首页是一个数据列表页，每个列表项中包含了以下几个内容：
- 静态内容（提问的问题的内容、发布时间等）
- 动态内容（浏览数量、点赞等）
- 音视频播放，需求为在列表项中可直接播放音视频，且该模块的展现根据数据的状态有所不同

在实际开发中，我将这个页面划分为了三层组件结构。首先，最外层是以`ListView`为核心的列表页，主要类函数有下拉刷新、底部加载更多、空数据展示等等。第二层是自定义的`ListViewItem`组件，主要利用`props`传入数据对象，然后用`state`存储组件的几个主要状态（支付情况、点赞情况等）。第三层是自定义的音视频模块`ModuleAnswer`，主要根据支付状态决定展现内容，同时自身维护一个下载状态和播放状态，来支持资源的下载与播放。

在这样的结构下，程序中的业务逻辑得到了高度复用。在需求中我们确实存在另一个页面需要调用首页的列表项，因此我直接调用`ListViewItem`组件就完成了；另外，在多个其他Tab页以及详情页中都涉及到了音视频展示和播放，因此我也重复调用了多个`ModuleAnswer`组件。调用组件时，我只需要传入`props`即可，不用关心组件内部的实现，整个项目的解耦得到了很好的保证。如果需要调用的子组件与父组件进行交互，只需传入一个回调函数即可。

## jsBridge
React Native自身也提供了一个jsBridge，用来实现js方法和native的方法的交互。一般来说，由于RN提供了大量原生组件的js封装，我们不需要手动调用这一层，只需执行js方法即可；但是自定义组件或修改原生组件时，就需要利用jsBridge实现交互。具体交互方式有以下几种：
1. 属性的传递，也就是传参：从原生传给js，需要在原生代码里传入`initialProperties`属性，在js中就可以访问到这个属性了。如果是从js传到原生，则需要将自定义组件用`RCT_CUSTOM_VIEW_PROPERTY`进行导出。
2. 方法调用：从原生调用js方法，主要利用事件监听来实现。从js调用原生方法，主要是利用原生编写自定义模块时，进行方法导出，在js中就可以进行调用。这个过程都是由jsBridge实现的。

这个jsBridge的实现原理基本可以概括为：RN为js模块和原生模块各自提供一个中间件，js模块的中间件为一个消息队列，用于监听事件和定时器等；原生模块的中间件是`RCTModuleMethod`模块，它利用`__fbBatchedBridgeConfig`这个变量使两个中间件维护同一个方法列表和参数列表。这两个中间件之间用回调的形式完成交互。

## 遇到的问题
### 原生控件的局限性
这个问题也不能说是RN的问题，是由于iOS控件的设计决定的。简单来说，就是诸如`Navigator`,`TabBar`,`ListView`这种组件很多属性无法自定义，只能以默认形式展现，导致一些需求无法按照正常逻辑进行实现。譬如说，在导航栏显示三个按钮，显示小红点，TabBar加入特殊按钮等。为了实现需求，我采用了绝对定位方式加入了新的组件，使元素看上去似乎在导航或者Tab组件的内部（其实不在），规避了原生组件的问题。如果使用自定义组件，其性能和可用功能相比原生来说得不到保证，因此最终还是选取原生为主hack为辅的方法来实现。
### 调试
很多时候调试页面出现的提示并不友好。这是由jsBridge的特性决定的，由某些错误导致程序崩溃后，错误断点直接停留在bridge层，这时的错误提示对于调试几乎没有任何意义，很多需要凭经验去推测。
### 组件通信
RN的组件通信方式是很少的，最最最常用的是子组件调用父组件的回调，也是最容易控制的逻辑。而页面中一个常见需求是，页面的`Navigator`是父组件，页面内容是子组件，现在需要根据导航栏上的按钮点击调用子组件的方法。这时就陷入了一个窘境，因为可以做的就是改变父组件的`state`，进而重新`render`页面，但是由于子组件的数据没有发生变化，RN的render机制保证了此时子组件是不会被重新刷新的，即使刷新也无法调用其中的某个函数。这时可以使用的方法就只剩下事件了，虽然RN提供了一个完整的事件监听和捕获机制，但是毕竟事件打破了模块的耦合关系，也大大提高了调试难度（因为不知道事件在哪里被监听和触发），所以在这种业务中使用事件是一个比较无奈的选择。
### 绝对定位
RN中绝对定位是相对于父元素的，这和css的`absolute`差不多，但是有一个比较严重的问题，绝对定位的偏移不能设置为百分比，只能是固定值，这就导致绝对定位的元素没法实现居中或者responsive的效果。事实上RN对于静态定位（默认）元素的动态布局做的是相当不错的，利用`justifyContent`和`alignItems`可以实现各种自适应的布局，但是绝对定位元素的布局还有待加强。
### zIndex
RN在0.29版之前是不支持zIndex属性的，导致Overlay这种常见功能还需要用原生代码来写，然后封装起来再调用。默认情况下，同一层级最后添加的组件显示在最上层，因此一些需要全局遮盖的组件往往挂在整个组件树的最后面。然而因此有些需求就变得很难做了，譬如一个自定义的`dropdown`，下拉元素的原始文本需要静态插入在某个组件中，而下拉菜单由于隶属于你的自定义组件，因此其顺序不一定在组件树最后，所以其没有空间可以进行显示。0.29之后增加了`zIndex`，这个问题解决了一半，因为此时元素可以显示了，但是仍然无法交互，因为在官方的commit中，明确说明了这个属性只改变显示顺序，不改变事件触发顺序，因此这个元素存在的位置只要被其他元素遮挡，虽然你能看见，但是点击时事件会被遮挡元素直接拦截掉。目前这种类似的浮动元素需求还多只能以原生代码实现，还是比较麻烦的。

## 打包发布
由于我们开发的最终产品是iOS客户端，因此打包发布流程相对于传统Web项目来说还要简单一些。只需经过正常编译生成应用文件`.ipa`，就可以分发给别人测试和运行了。React Native内置了一个webpack进行js资源的打包。在本项目中我们使用了网易内部的测试平台**网易测试服务**，使用该平台进行了应用的企业证书签名和发布。
由于项目中的代码最终都编译成了应用模块，因此静态资源只有图片一项了。由于项目中只用到了一些图标，图片元素应用不多，因此最终App大小只有2.1M，还是可以接受的体积（同时安卓客户端达到了20M，精简后也还有10M大小）。
